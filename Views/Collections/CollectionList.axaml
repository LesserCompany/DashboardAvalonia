<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:LesserDashboardClient.ViewModels.Collections"
             xmlns:local="clr-namespace:LesserDashboardClient.Views.Collections"
             x:DataType="vm:CollectionsViewModel"
             xmlns:ui="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia.ProgressRing"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="LesserDashboardClient.Views.Collections.CollectionList">
  
    <Grid RowDefinitions="Auto, Auto, *, Auto" RowSpacing="6" >
        <Grid Grid.Row="0" ColumnDefinitions="Auto, *" ColumnSpacing="6" >
            <Image Width="64" Height="64" Source="{SvgImage /Assets/symbol.svg}" />
            <Grid Grid.Column="1" RowSpacing="6" ColumnSpacing="6" RowDefinitions="Auto, Auto" ColumnDefinitions="Auto, *" VerticalAlignment="Center" IsEnabled="{Binding IsEnabledFilters}">
                <TextBlock FontSize="12" Grid.Row="0" Grid.Column="0" Text="{Tr 'ID collection:'}" VerticalAlignment="Center"  />
                <TextBox Grid.Row="0" Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Center" Name="tbFilterClassCode" TextChanged="TextBox_TextChanged"/>
                
                <TextBlock FontSize="12" Grid.Row="1" Grid.Column="0" Text="{Tr 'Separator:'}" VerticalAlignment="Center" />
                <TextBox Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Center" Name="tbFilterProfessional" TextChanged="TextBox_TextChanged" />
            </Grid>
        </Grid>
        <Button IsEnabled="{Binding !LoadProfessionalsIsRunning}" Grid.Row="1"  HorizontalAlignment="Stretch" Command="{Binding OpenQuickAccessViewCommand}" Background="Transparent" >
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="6">
                <Image Source="avares://LesserDashboard/Assets/addFolderIcon.png" Width="50" Height="50" VerticalAlignment="Center" />
                <TextBlock Text="{Tr 'Create new collection'}" VerticalAlignment="Center" />
            </StackPanel>
        </Button>
            <local:SkeletonList Grid.Row="2" IsVisible="{Binding CollectionsListIsLoading}" />
            <!--
            <ui:ProgressRing Grid.Row="2" IsIndeterminate="True" BorderThickness="8" Width="48" Height="48" IsVisible="{Binding CollectionsListIsLoading}" />
            -->      
            <ScrollViewer Grid.Row="2" 
                         IsVisible="{Binding !CollectionsListIsLoading}"
                         VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Disabled">
              <StackPanel>
                <!-- Loading enquanto busca no servidor -->
                <StackPanel Orientation="Horizontal" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           Spacing="12"
                           Margin="0,24,0,0"
                           IsVisible="{Binding IsSearchingOnServer}">
                  <ui:ProgressRing Width="24" Height="24" 
                                   IsIndeterminate="True" 
                                   BorderThickness="4"/>
                  <TextBlock Text="{Tr 'Searching on server...'}" 
                            VerticalAlignment="Center"
                            FontSize="14"/>
                </StackPanel>
                
                <!-- Mensagem quando não encontrou nada -->
                <StackPanel Orientation="Vertical" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           Spacing="8"
                           Margin="0,24,0,0"
                           IsVisible="{Binding ShowNoResultsMessage}">
                  <TextBlock Text="{Tr 'No collection found'}" 
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            FontSize="14"
                            Foreground="{DynamicResource MetaFg}"/>
                  <TextBlock Text="{Tr 'No collection was found matching your search criteria.'}" 
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            FontSize="12"
                            Foreground="{DynamicResource MetaFg}"
                            TextWrapping="Wrap"
                            TextAlignment="Center"
                            MaxWidth="400"/>
                </StackPanel>
                
                <ListBox FontSize="11" 
                         Background="Transparent"
                         BorderThickness="0"
                         ItemsSource="{Binding CollectionsListFiltered}" 
                         SelectedItem="{Binding SelectedCollection, Mode=TwoWay}">

                  <!-- Garante virtualização simples e barata -->
                  <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                      <VirtualizingStackPanel/>
                    </ItemsPanelTemplate>
                  </ListBox.ItemsPanel>

                  <!-- "Chrome" do card no container, não no template (menos elementos por item) -->
                  <ListBox.Styles>
                    <Style Selector="ListBoxItem">
                      <Setter Property="Margin" Value="0,6,0,6"/>
                      <Setter Property="Padding" Value="12"/>
                      <Setter Property="Background" Value="{DynamicResource CardBg}"/>
                      <Setter Property="BorderBrush" Value="{DynamicResource CardBorder}"/>
                      <Setter Property="BorderThickness" Value="1"/>
                      <Setter Property="CornerRadius" Value="12"/>
                      <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                      <Setter Property="FocusAdorner" Value="{x:Null}"/>
                    </Style>

                    <Style Selector="ListBoxItem:pointerover">
                      <Setter Property="Background" Value="{DynamicResource CardBgHover}"/>
                    </Style>

                    <Style Selector="ListBoxItem:selected">
                      <Setter Property="BorderBrush" Value="{DynamicResource Accent}"/>
                    </Style>
                  </ListBox.Styles>

                  <!-- Template com árvore enxuta (nada de efeitos) -->
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <!-- 3 colunas: avatar | conteúdo | badges -->
                      <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">

                        <!-- Avatar + label de ambiente -->
                        <StackPanel Grid.RowSpan="3" Margin="0,2,12,0" VerticalAlignment="Center">
                          <Border Background="{DynamicResource BadgeBg}" CornerRadius="6" Padding="6,2" Margin="0,2,0,0"
                                  IsVisible="{Binding UploadOnTestSystem, FallbackValue=False}">
                            <TextBlock Text="TEST" Foreground="{DynamicResource BadgeFg}" FontWeight="SemiBold" FontSize="9"/>
                          </Border>
                          <local:ProfessionalRepresentation ProfessionalName="{Binding professionalLogin}" 
                                                           Margin="0,6,0,0"/>
                        </StackPanel>

                        <!-- Título (classCode) -->
                        <TextBlock Grid.Column="1"
                                   Text="{Binding classCode}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Margin="0,0,8,0"
                                   TextWrapping="NoWrap"
                                   TextTrimming="CharacterEllipsis"
                                   TextDecorations="{Binding BillingCancelled, Converter={StaticResource BoolToTextDecorationConverter}}"
                                   ToolTip.Tip="{Binding classCode}"/>

                        <!-- Badges alinhados à direita -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6"
                                    HorizontalAlignment="Right" VerticalAlignment="Center">
                          <!-- HD -->
                          <Border Background="{DynamicResource BadgeBg}" CornerRadius="6" Padding="6,3"
                                  IsVisible="{Binding UploadHD, FallbackValue=False}">
                            <TextBlock Text="HD" Foreground="{DynamicResource BadgeFg}" FontWeight="SemiBold"/>
                          </Border>
                          <!-- AutoTreatment -->
                          <local:AutoTreatmentIcon IsVisible="{Binding AutoTreatment, FallbackValue=False}"/>
                          <!-- Vendas habilitadas -->
                          <local:PhotoSalesIcon IsVisible="{Binding EnablePhotosSales, FallbackValue=False}"/>
                          <!-- OCR -->
                          <local:OcrIcon IsVisible="{Binding OCR, FallbackValue=False}"/>
                        </StackPanel>

                        <!-- Linha meta: total de fotos + data + separador -->
                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                          <TextBlock Text="{Tr 'Total photos:'}" TextDecorations="{Binding BillingCancelled, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                          <TextBlock TextDecorations="{Binding BillingCancelled, Converter={StaticResource BoolToTextDecorationConverter}}">
                            <TextBlock.Text>
                              <MultiBinding Converter="{StaticResource MultiBindingSumConverter}">
                                <Binding Path="recognitionPhotos" />
                                <Binding Path="eventPhotos" />
                              </MultiBinding>
                            </TextBlock.Text>
                          </TextBlock>
                          <TextBlock Text="•" TextDecorations="{Binding BillingCancelled, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                          <TextBlock Text="{Binding CreationDate, Converter={StaticResource DateTimeToStringConverter}}" 
                                     ToolTip.Tip="{Binding CreationDate}" 
                                     FontSize="9"
                                     TextDecorations="{Binding BillingCancelled, Converter={StaticResource BoolToTextDecorationConverter}}"/>
                        </StackPanel>

                        <!-- Status (upload/tratamento) -->
                        <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="10" Margin="0,6,0,0">
                          <TextBlock Text="{Tr 'Waiting for upload...'}" 
                                     Foreground="Red" 
                                     IsVisible="{Binding !UploadComplete, FallbackValue=False}"/>
                          <TextBlock Text="HD pronto" 
                                     Foreground="{DynamicResource MetaFg}"
                                     IsVisible="{Binding UploadHD, FallbackValue=False}"/>
                        </StackPanel>

                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Botão de carregar mais -->
                <Button Grid.Row="3" 
                        Margin="0,12,0,0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Padding="16,8"
                        Background="{DynamicResource CardBg}"
                        BorderBrush="{DynamicResource CardBorder}"
                        BorderThickness="1"
                        CornerRadius="8"
                        IsVisible="{Binding ShowLoadMoreButton}"
                        IsEnabled="{Binding !IsLoadingMoreTasks}"
                        Command="{Binding LoadMoreTasksCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <ui:ProgressRing Width="16" Height="16" 
                                     IsIndeterminate="True" 
                                     IsVisible="{Binding IsLoadingMoreTasks}"/>
                    <TextBlock Text="{Binding LoadOldButtonText}"
                               FontSize="12"
                               VerticalAlignment="Center"/>
                  </StackPanel>
                </Button>
              </StackPanel>
            </ScrollViewer>
    </Grid>
</UserControl>
